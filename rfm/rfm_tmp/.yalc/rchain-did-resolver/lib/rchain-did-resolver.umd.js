!function(r,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("rchain-toolkit"),require("pako"),require("uint8arrays"),require("elliptic")):"function"==typeof define&&define.amd?define(["exports","rchain-toolkit","pako","uint8arrays","elliptic"],e):e((r||self).rchainDidResolver={},r.rchainToolkit,r.pako,r.uint8Arrays,r.elliptic)}(this,function(r,e,t,n,i){function o(r,e){(null==e||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}var a=require("rchain-token-files"),u=a.readBagOrTokenDataTerm,l=a.read,c=new i.ec("secp256k1");function s(){var r=new Map;return function(e,t){try{var n,i=function(i){if(n)return i;var o=r.get(e.did);return void 0!==o?o:Promise.resolve(t()).then(function(t){return null!==t&&r.set(e.did,t),t})},o=function(){if(e.params&&"true"===e.params["no-cache"])return n=1,Promise.resolve(t())}();return Promise.resolve(o&&o.then?o.then(i):i(o))}catch(r){return Promise.reject(r)}}}function f(r,e){return e()}var d=new RegExp("^did:([a-zA-Z0-9_]+):([a-zA-Z0-9_.-]+(:[a-zA-Z0-9_.-]+)*)((;[a-zA-Z0-9_.:%-]+=[a-zA-Z0-9_.:%-]*)*)(/[^#?]*)?([?][^#]*)?(#.*)?$");function p(r){if(""===r||!r)throw new Error("Missing DID");var e=r.match(d);if(e){var t={did:"did:"+e[1]+":"+e[2],method:e[1],id:e[2],didUrl:r};if(e[4]){var n=e[4].slice(1).split(";");t.params={};for(var i,a=function(r,e){var t;if("undefined"==typeof Symbol||null==r[Symbol.iterator]){if(Array.isArray(r)||(t=function(r,e){if(r){if("string"==typeof r)return o(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);return"Object"===t&&r.constructor&&(t=r.constructor.name),"Map"===t||"Set"===t?Array.from(r):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?o(r,e):void 0}}(r))){t&&(r=t);var n=0;return function(){return n>=r.length?{done:!0}:{done:!1,value:r[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(t=r[Symbol.iterator]()).next.bind(t)}(n);!(i=a()).done;){var u=i.value.split("=");t.params[u[0]]=u[1]}}return e[6]&&(t.path=e[6]),e[7]&&(t.query=e[7].slice(1)),e[8]&&(t.fragment=e[8].slice(1)),t}throw new Error("Invalid DID "+r)}function h(r){var e=c.keyFromPublic(r,"hex").getPublic(!0,"array"),t=new Uint8Array(e.length+2);return t[0]=231,t[1]=1,t.set(e,2),"did:key:z"+n.toString(t,"base58btc")}r.Resolver=function(){function r(r,e){void 0===r&&(r={}),this.registry=r,this.cache=!0===e?s():e||f}return r.prototype.resolve=function(r){try{var e,t=this,n=function(r){if(e)return r;throw new Error("Unsupported DID method: '"+i.method+"'")},i=p(r),o=t.registry[i.method],a=function(){if(o)return Promise.resolve(t.cache(i,function(){return o(i.did,i,t)})).then(function(r){if(null==r)throw new Error("resolver returned null for "+i.did);return e=1,r})}();return Promise.resolve(a&&a.then?a.then(n):n(a))}catch(r){return Promise.reject(r)}},r}(),r.encodeDIDFromPubKey=h,r.getResolver=function(){return{rchain:function(r,n,i){try{var o,a;return o=n.path&&""!==n.path?u(n.id,"bags",null==(a=n.path)?void 0:a.substring(1)):l(n.id),Promise.resolve(e.http.exploreDeploy("http://localhost:40403",{term:o})).then(function(r){if(n.path&&""!==n.path){var i={};try{var o=Buffer.from(decodeURI(e.utils.rhoValToJs(JSON.parse(r).expr[0])),"base64"),a=Buffer.from(t.inflate(o)).toString("utf-8");i=JSON.parse(a)}finally{}return i}var u=e.utils.rhoValToJs(JSON.parse(r).expr[0]),l=h(u.publicKey),c=l.substr(8),s=l+"#"+c;return{id:l,publicKey:[{id:s,type:"Secp256k1VerificationKey2018",controller:s,publicKeyHex:u.publicKey}]}})}catch(r){return Promise.reject(r)}}}},r.inMemoryCache=s,r.noCache=f,r.parse=p});
//# sourceMappingURL=rchain-did-resolver.umd.js.map
